<!doctype html><html lang=en-US><head><script integrity=sha384-IpIaa84kOKgkF5EJ0fD/kBe2wtIIsIB60ANGmuJxeA0dz5bSRfwBwp2/QybtQpU2 src=https://simbleau.github.io/blog/theme.min.js></script><link href="https://simbleau.github.io/blog/abridge-blue-switcher.css?h=d25bd4adb08ba6ca2e646a2b6ce29ab5c2165daab499e98fdc68c9b0460d9475" rel=stylesheet><link href="https://simbleau.github.io/blog/blog-icons.css?h=93c7fa222494dad48da7ee34225b8ea011de3fa35cecbcb68e6d8fc51103045d" rel=stylesheet><link href="https://simbleau.github.io/blog/blog-brands.css?h=7c7030e72912029a2a591c9e9c0185eb2009b5f20001fe7ba8fb35022e3b03d1" rel=stylesheet><meta charset=utf-8><meta content="ie=edge" http-equiv=x-ua-compatible><meta content="width=device-width,initial-scale=1,shrink-to-fit=no" name=viewport><script src="https://simbleau.github.io/blog/search_index.en.js?h=787801211c89cd751dcf3a85d634f1f159892d500faf6acb33f72eea10cf5f2c" defer integrity=sha384-hzdD2XGCvsuyynjHYmFlwgRXxNkpLNrk0Us44kQ4kFfwufxDgnpUQzOhJEpOYVv8></script><script src="https://simbleau.github.io/blog/abridge-switcher.min.js?h=be6d42ac1cc5ae1da7cdde772d392d6508fc038f98a8d0fd1bc5b5678530631a" defer integrity=sha384-RAhv9DQbxrVfq4cbSJsOQ8l7sA56QdpoR10euhjBCBOhLdbJ6y8SCZVYy818n51+></script><link title="Atom/RSS Feed" href=https://simbleau.github.io/blog/rss.xml rel=alternate type=application/rss+xml><meta content="index, follow" name=robots><meta content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1" name=googlebot><meta content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1" name=bingbot><title>NVIDIA GPU profiling with Rust | Spencer C. Imbleau</title><meta content="Spencer C. Imbleau" name=author><meta content="Spencer C. Imbleau" name=copyright><meta content="The NVIDIA Tools Exension SDK (NVTX) has a lot to offer for GPU and CPU profiling. This blog shows how to leverage these tools with Rust, and how we can make sense of the results." name=description><link href=https://simbleau.github.io/blog/gpu-profiling-with-rust/ rel=canonical><meta content="blog, kubernetes, k8s, cloud, rust" name=keywords><meta content=https://simbleau.github.io/blog/gpu-profiling-with-rust/ property=og:url><meta content=https://simbleau.github.io/blog/gpu-profiling-with-rust/ name=twitter:url><meta content="The NVIDIA Tools Exension SDK (NVTX) has a lot to offer for GPU and CPU profiling. This blog shows how to leverage these tools with Rust, and how we can make sense of the results." property=og:description><meta content="The NVIDIA Tools Exension SDK (NVTX) has a lot to offer for GPU and CPU profiling. This blog shows how to leverage these tools with Rust, and how we can make sense of the results." name=twitter:description><meta content="NVIDIA GPU profiling with Rust | Spencer C. Imbleau" property=og:title><meta content="NVIDIA GPU profiling with Rust | Spencer C. Imbleau" name=twitter:title><meta content=summary_large_image name=twitter:card><meta content=https://simbleau.github.io/blog/banner.png name=twitter:image><meta content=https://simbleau.github.io/blog/banner.png property=og:image><meta content="Spencer C. Imbleau" property=og:site_name><meta content=en_US property=og:locale><meta content=website property=og:type><meta content=2022-06-19 property=og:updated_time><meta content=@spencerimbleau name=twitter:site><meta content=@spencerimbleau name=twitter:creator><meta content=True name=HandheldFriendly><meta content=yes name=mobile-web-app-capable><meta content=yes name=apple-mobile-web-app-capable><meta content=default name=apple-mobile-web-app-status-bar-style><meta content=#FFFFFF name=theme-color><meta content=#FFFFFF name=msapplication-TileColor><link href=https://simbleau.github.io/blog/site.webmanifest rel=manifest><link color=#0099FF href=https://simbleau.github.io/blog/safari-pinned-tab.svg rel=mask-icon><link href=https://simbleau.github.io/blog/apple-touch-icon.png rel=apple-touch-icon sizes=180x180><link href=https://simbleau.github.io/blog/favicon-32x32.png rel=icon sizes=32x32 type=image/png><link href=https://simbleau.github.io/blog/favicon-16x16.png rel=icon sizes=16x16 type=image/png><noscript><link href=https://simbleau.github.io/blog/nojs.css rel=stylesheet></noscript><body><header><nav><div><h1><a href=https://simbleau.github.io/blog/>Spencer C. Imbleau</a></h1></div><div><ul><li><h2><a href=https://simbleau.github.io/blog/donate/><i class="svgs i-donate"></i> Donate</a></h2><li><h2><a href=https://simbleau.github.io/blog/posts/><i class="svgs i-posts"></i> Posts</a></h2><li><h2><a href=https://simbleau.github.io/blog/categories/><i class="svgs i-categories"></i> Categories</a></h2><li><h2><a href=https://simbleau.github.io/blog/tags/><i class="svgs i-tags"></i> Tags</a></h2><li class=js><i class="svgs i-moon" id=mode type=reset></i></ul></div><div><form class=js name=goSearch><div class=searchd><input autocomplete=off id=userinput placeholder=Search><button title=Search><i class="svgs i-search"></i></button></div><div><div id=suggestions></div></div></form></div></nav><hr></header><main><article><h1><a href=https://simbleau.github.io/blog/gpu-profiling-with-rust/>NVIDIA GPU profiling with Rust</a></h1><span class=false><i class="svgs i-glasses"></i> 7 min read<span class=hpad> </span><i class="svgs i-calendar"></i> June 19, 2022<span class=hpad> </span><i class="svgs i-info"></i> [<a href=https://simbleau.github.io/blog/categories/rust/>Rust</a>] #<a href=https://simbleau.github.io/blog/tags/rust/>rust</a> #<a href=https://simbleau.github.io/blog/tags/graphics/>graphics</a> </span><p>Not too long ago, I had to perform CPU and GPU profiling in support of rendering a thesis<sup class=footnote-reference><a href=#thesis>1</a></sup>. When I realized the ecosystem of GPU profiling tools in Rust was somewhat immature, I had to scaffold my own tools out of necessity. This post will demonstrate how anyone can use the NVIDIA Tools Extension SDK (NVTX) from Rust to make GPU and CPU profiling trivial.<h1 id=introduction-to-nvtx>Introduction to NVTX</h1><p>NVTX is a C-based API for annotating events, code, and resources in your application. These annotations get captured by NVIDIA profiling software, such as NSight Systems<sup class=footnote-reference><a href=#nsight_systems>2</a></sup>. Emitting tracer annotations during the runtime of your program can help identify key issues such as hardware starvation, insufficient parallelization, expensive algorithms, and more. Later in this post we will explore an example (<a href=https://simbleau.github.io/blog/gpu-profiling-with-rust/#show-me>#show-me</a>).<p>Thankfully, one of Rust's promises is its ability to interoperate with C APIs through foreign function interfacing (FFI) at identical performance<sup class=footnote-reference><a href=#zero_cost_abstractions>3</a></sup>. This is called a zero-cost abstraction, and allows us to call NVTX functions with identical performance to C, in Rust.<h1 id=nsight-systems>NSight Systems</h1><p>NSight Systems is a feature-ruch CLI and GUI profiler which executes a command and samples certain opt-in measurements you subscribe to. For example, if I instruct NVIDIA Nsight Systems to run a binary, Nsight Systems will launch the binary on my behalf, collect measurements while waiting for termination, and deliver a report file. In that order.<div align=center><img alt="NSight Systems" height=600 src=NSight_Systems_Example.png width=838><p>An NVIDIA NSight Systems Report, viewed with NSight Systems</div><p>These reports can be better understood with annotations from my <a href=https://crates.io/crates/nvtx rel=noopener target=_blank>nvtx crate</a>. With it, you may name your threads, add markers, and annotate timespans. Tracers emitted during program runtime appear on the NVTX layer of a report file when capturing NVTX annotations. The following image shows an example of some tracers, with nothing else captured.<div align=center><img alt="NVTX Annoations" height=542 src=NVTX_Example.png width=901><p>A thread range and two event markers annoted with <a href=https://crates.io/crates/nvtx rel=noopener target=_blank>nvtx</a>.</div><h1 id=code>Code</h1><p>The following sections provide some examples which demonstrate how trivial it is to augment runtime with annotations.<h2 id=markers>Markers</h2><p>Firstly, I will show markers. Markers are used to tag instantaneous events during the execution of an application. For example, dropping a marker can be used to annotate a step in an algorithm.<p>Markers are injected with the <code>mark!</code> macro, which accepts a name for the event. It behaves similarly to the <code>println!</code> macro with argument formatting.<pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"><span class="z-keyword z-other z-rust">use</span> <span class="z-meta z-path z-rust">std<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-path z-rust">thread<span class="z-punctuation z-accessor z-rust">::</span></span>sleep<span class="z-punctuation z-terminator z-rust">;</span>
<span class="z-keyword z-other z-rust">use</span> <span class="z-meta z-path z-rust">std<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-path z-rust">time<span class="z-punctuation z-accessor z-rust">::</span></span>Duration<span class="z-punctuation z-terminator z-rust">;</span>

<span class="z-keyword z-other z-rust">use</span> <span class="z-meta z-path z-rust">nvtx<span class="z-punctuation z-accessor z-rust">::</span></span>mark<span class="z-punctuation z-terminator z-rust">;</span>

<span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">main</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
    <span class="z-support z-macro z-rust">mark!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span>Operation A - Begin<span class="z-punctuation z-definition z-string z-end z-rust">"</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
    <span class="z-support z-function z-rust">sleep</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-path z-rust">Duration<span class="z-punctuation z-accessor z-rust">::</span></span>from_millis<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-constant z-numeric z-integer z-decimal z-rust">150</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span> <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> Expensive operation here
</span>    <span class="z-support z-macro z-rust">mark!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span>Operation B - Begin<span class="z-punctuation z-definition z-string z-end z-rust">"</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
    <span class="z-support z-function z-rust">sleep</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-path z-rust">Duration<span class="z-punctuation z-accessor z-rust">::</span></span>from_millis<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-constant z-numeric z-integer z-decimal z-rust">75</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span> <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> Expensive operation here
</span></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre><div align=center><img alt="NVTX Marker" height=129 src=Marker_Example.png width=1410><p>Two named markers visible through the events view on NSight Systems.</div><h2 id=thread-ranges>Thread ranges</h2><p>Thread ranges are similar to markers, except they annotate a span of time, rather than an instant of time. For example, a thread range can track the total time of an algorithm or process.<p>Ranges are pushed with the <code>range_push!</code> macro, and popped with the <code>range_pop!</code> macro. Thread ranges are also safe to push and pop over thread boundaries, hence <em>thread</em> in the name.<pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"><span class="z-keyword z-other z-rust">use</span> <span class="z-meta z-path z-rust">std<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-path z-rust">thread<span class="z-punctuation z-accessor z-rust">::</span></span>sleep<span class="z-punctuation z-terminator z-rust">;</span>
<span class="z-keyword z-other z-rust">use</span> <span class="z-meta z-path z-rust">std<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-path z-rust">time<span class="z-punctuation z-accessor z-rust">::</span></span>Duration<span class="z-punctuation z-terminator z-rust">;</span>

<span class="z-keyword z-other z-rust">use</span> <span class="z-meta z-path z-rust">nvtx<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>range_pop<span class="z-punctuation z-separator z-rust">,</span> range_push</span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span><span class="z-punctuation z-terminator z-rust">;</span>

<span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">main</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
    <span class="z-support z-macro z-rust">range_push!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span>My Range<span class="z-punctuation z-definition z-string z-end z-rust">"</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
    <span class="z-support z-function z-rust">sleep</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-path z-rust">Duration<span class="z-punctuation z-accessor z-rust">::</span></span>from_millis<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-constant z-numeric z-integer z-decimal z-rust">100</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span> <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> Expensive operation here
</span>    <span class="z-support z-macro z-rust">range_pop!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre><div align=center><img alt="NVTX Thread Range" height=600 src=Range_Example.png width=1148><p>A range viewable from the timeline and events view in NSight Systems.</div><h2 id=thread-naming>Thread naming</h2><p>Lastly, threads can be named with the <code>name_thread!</code> macro. This macros will alias the calling OS thread with a friendly name. Currently, this macro works cross-platform and has been tested on MacOS, Windows, Linux, and Android.<pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"><span class="z-keyword z-other z-rust">use</span> <span class="z-meta z-path z-rust">std<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-path z-rust">thread<span class="z-punctuation z-accessor z-rust">::</span></span>sleep<span class="z-punctuation z-terminator z-rust">;</span>
<span class="z-keyword z-other z-rust">use</span> <span class="z-meta z-path z-rust">std<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-path z-rust">time<span class="z-punctuation z-accessor z-rust">::</span></span>Duration<span class="z-punctuation z-terminator z-rust">;</span>

<span class="z-keyword z-other z-rust">use</span> <span class="z-meta z-path z-rust">nvtx<span class="z-punctuation z-accessor z-rust">::</span></span>name_thread<span class="z-punctuation z-terminator z-rust">;</span>

<span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">main</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
    <span class="z-support z-macro z-rust">name_thread!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span>Main Thread<span class="z-punctuation z-definition z-string z-end z-rust">"</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
    <span class="z-storage z-type z-rust">let</span> handler2 <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-meta z-path z-rust">thread<span class="z-punctuation z-accessor z-rust">::</span></span>spawn<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">|</span></span></span><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">|</span></span> </span><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
        <span class="z-support z-macro z-rust">name_thread!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span>Thread 2<span class="z-punctuation z-definition z-string z-end z-rust">"</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
        <span class="z-support z-function z-rust">sleep</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-path z-rust">Duration<span class="z-punctuation z-accessor z-rust">::</span></span>from_secs_f32<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-constant z-numeric z-float z-rust">0.</span><span class="z-constant z-numeric z-float z-rust">2</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
    <span class="z-storage z-type z-rust">let</span> handler3 <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-meta z-path z-rust">thread<span class="z-punctuation z-accessor z-rust">::</span></span>spawn<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">|</span></span></span><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">|</span></span> </span><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
        <span class="z-support z-macro z-rust">name_thread!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span>Thread 3<span class="z-punctuation z-definition z-string z-end z-rust">"</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
        <span class="z-support z-function z-rust">sleep</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-path z-rust">Duration<span class="z-punctuation z-accessor z-rust">::</span></span>from_secs_f32<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-constant z-numeric z-float z-rust">0.</span><span class="z-constant z-numeric z-float z-rust">3</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
    <span class="z-support z-function z-rust">sleep</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-path z-rust">Duration<span class="z-punctuation z-accessor z-rust">::</span></span>from_secs_f32<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-constant z-numeric z-float z-rust">0.</span><span class="z-constant z-numeric z-float z-rust">5</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
    handler2<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">join</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">unwrap</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
    handler3<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">join</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">unwrap</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre><div align=center><img alt="NVTX Thread Naming" height=466 src=Thread_Example.png width=1154><p>Three named threads.</div><h1 id=show-me>Show me</h1><p>To demonstrate NSight Systems, NVTX, and Rust, I will present a finding I organically stumbled upon when writing a <a href=https://github.com/simbleau/svg-tessellation-renderer rel=noopener target=_blank>naive SVG renderer</a> using <a href=https://github.com/nical/lyon rel=noopener target=_blank>Lyon</a> and <a href=https://wgpu.rs/ rel=noopener target=_blank>wgpu</a>.<h2 id=situation>Situation</h2><p>My task was assessing if tessellation could have any usefulness in optimizing vector graphics. Vector graphic renderers solve a very complicated problem; they don't simply read rows of pixels like in raster graphics. You may imagine an SVG file as a composition of overlapping paths and lines, and a renderer must decide on varyings (scale, viewbox, etc.) to calculate the image.<div align=center><img alt="Sample Images" height=300 src=renderkit.svg width=1969></div><p>Vector tessellation makes this easier. The idea is to transmute mathematical paths, curves, and lines into discrete triangles, a friendlier format for GPUs. My renderer would cache the triangle geometry in a storage buffer and re-use the work to inexpensively redraw the SVG.<p>I chose some sample images as an organic range with varying complexity, and proceeded to benchmark the frametimes.<div align=center><img alt="Sample Images" height=300 src=all_images.svg width=1969></div><h2 id=results>Results</h2><p>The benchmark was simple: render 50 frames and record how long each frame took. The results are plotted below.<div align=center><img alt="My Results" height=432 src=all_renderkit.svg width=576></div><p>Tessellation-time was not plotted here, and no frame was rendered any differently. So to my surprise, why was the first frame taking longer? Using the power of NVTX annotations, I dropped some tracers to understand the instructions temporally. I annotated the first frame as "<em>Strange Behavior</em>".<div align=center><img alt="NTVX Tracers" height=965 src=NVTX_Trace.png width=2243></div><p>To my surprise, it seemed like the GPU wasn't working hard until the 2nd frame. The reasoning would be that wgpu (the graphics library I used) submitted the queue of geometry in the first frame. What we are witnessing is gpu latency, specifically, the time to transfer the geometry to the GPU storage buffers and return. This became an obvious que when able to inspect and see a timeline with ques: blocked state, PCIe bandwidth, and GPU occupancy.<p>This is one example of how annotations have helped me, and work will continue to help in more ways.<h1 id=features-in-progress>Features in progress</h1><p>I have only ported a fraction of the NVTX SDK, and there are some noteworthy features outstanding. NVTX can be used to measure CPU code blocks, track lifetime of CPU resources (e.g., malloc), log critical events<sup class=footnote-reference><a href=#nvtx_def>4</a></sup>, and more. I'd love to port <a href=https://nvidia.github.io/NVTX/doxygen/index.html#DOMAINS rel=noopener target=_blank>filtering tracers by domains</a> and <a href=https://nvidia.github.io/NVTX/doxygen/index.html#RESOURCE_NAMING rel=noopener target=_blank>resource naming</a>. Feel free to contribute or check out the <a href=https://github.com/simbleau/nvtx/issues rel=noopener target=_blank>issue board</a>.<p><em>Farvel! Until next time.</em><hr><div class=footnote-definition id=thesis><sup class=footnote-definition-label>1</sup><p><a href=http://dx.doi.org/10.13140/RG.2.2.25593.54887 rel=noopener target=_blank>Understanding Hardware-Accelerated 2D Vector Graphics</a></div><div class=footnote-definition id=nsight_systems><sup class=footnote-definition-label>2</sup><p><a href=https://developer.nvidia.com/nsight-systems rel=noopener target=_blank>NVIDIA NSight Systems</a></div><div class=footnote-definition id=zero_cost_abstractions><sup class=footnote-definition-label>3</sup><p><a href=https://blog.rust-lang.org/2015/04/24/Rust-Once-Run-Everywhere.html rel=noopener target=_blank>Run Once, Run Everywhere</a></div><div class=footnote-definition id=nvtx_def><sup class=footnote-definition-label>4</sup><p><a href=https://docs.nvidia.com/nsight-visual-studio-edition/2020.1/nvtx/index.html#nvidia-tools-extension-library-nvtx rel=noopener target=_blank>The NVIDIA Tools Extension Library (NVTX)</a></div><div class=footnote-definition id=examples><sup class=footnote-definition-label>5</sup><p><a href=https://github.com/simbleau/nvtx/tree/main/examples rel=noopener target=_blank>Examples using the nvtx crate</a></div><p><b><a href=#>Back to top</a></b></article><div class=toc><div class=toc-sticky><h3>Index</h3><div class=toc-item><a class=subtext href=https://simbleau.github.io/blog/gpu-profiling-with-rust/#introduction-to-nvtx>Introduction to NVTX</a></div><div class=toc-item><a class=subtext href=https://simbleau.github.io/blog/gpu-profiling-with-rust/#nsight-systems>NSight Systems</a></div><div class=toc-item><a class=subtext href=https://simbleau.github.io/blog/gpu-profiling-with-rust/#code>Code</a></div><div class=toc-item-child><a class=subtext href=https://simbleau.github.io/blog/gpu-profiling-with-rust/#markers><small>- Markers</small></a></div><div class=toc-item-child><a class=subtext href=https://simbleau.github.io/blog/gpu-profiling-with-rust/#thread-ranges><small>- Thread ranges</small></a></div><div class=toc-item-child><a class=subtext href=https://simbleau.github.io/blog/gpu-profiling-with-rust/#thread-naming><small>- Thread naming</small></a></div><div class=toc-item><a class=subtext href=https://simbleau.github.io/blog/gpu-profiling-with-rust/#show-me>Show me</a></div><div class=toc-item-child><a class=subtext href=https://simbleau.github.io/blog/gpu-profiling-with-rust/#situation><small>- Situation</small></a></div><div class=toc-item-child><a class=subtext href=https://simbleau.github.io/blog/gpu-profiling-with-rust/#results><small>- Results</small></a></div><div class=toc-item><a class=subtext href=https://simbleau.github.io/blog/gpu-profiling-with-rust/#features-in-progress>Features in progress</a></div></div></div></main><footer><hr><div class=c><nav><ul><li><a href=https://simbleau.github.io/blog/rss.xml target=_blank><i class="svg rss" title="Atom/RSS Feed" type=Button></i></a><li><a href=mailto:spencer@imbleau.com target=_blank><i class="svg mail" title=Mail type=Button></i></a><li><a href=https://twitter.com/spencerimbleau/ target=_blank><i class="svg twitter" title=Twitter type=Button></i></a><li><a href=https://www.linkedin.com/in/simbleau/ target=_blank><i class="svg linkedin" title=LinkedIn type=Button></i></a><li><a href=https://www.researchgate.net/profile/Spencer-Imbleau/ target=_blank><i class="svg researchgate" title=ResearchGate type=Button></i></a><li><a href=https://github.com/simbleau/ target=_blank><i class="svg github" title=Github type=Button></i></a><li><a href=https://www.buymeacoffee.com/simbleau/ target=_blank><i class="svg buymeacoffee" title="Buy Me A Coffee" type=Button></i></a><li><a href=https://github.com/sponsors/simbleau/ target=_blank><i class="svg github-sponsor" title="GitHub Sponsor" type=Button></i></a></ul></nav><p>Copyright © 2022 Spencer C. Imbleau<nav><ul></ul></nav> Built with <i class="svgs i-coffee"></i> and a <i class="svgs i-keyboard"></i> using <i class="svgs b-rust"></i><br><small><a href=https://github.com/simbleau/blog><i class="svgs i-edit"></i> Edit on GitHub</a></small></div></footer><span class=topout> <span class=topleft> </span><a class=top href=#><i class="svgs i-angles-up"></i></a> </span>